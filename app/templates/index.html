<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phân tích Ngữ pháp Tiếng Anh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-dot {
            height: 10px; width: 10px; border-radius: 50%; display: inline-block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .corrected-text { color: #27ae60; font-weight: 500; }
        .original-text { color: #e74c3c; text-decoration: line-through; }
        .sentence-container:not(:last-child) { margin-bottom: 1rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Kiểm tra Ngữ pháp Tiếng Anh</h1>
            <p class="text-lg text-gray-600 mt-2">Chuyển đổi giọng nói, chỉnh sửa và nhận phân tích chi tiết.</p>
        </header>

        <main class="bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-8">
            <!-- Phần Input -->
            <section>
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">1. Nhập liệu</h2>
                <div class="grid md:grid-cols-2 gap-6 items-center mb-6">
                    <!-- Ghi âm -->
                    <div class="flex flex-col items-center p-4 border rounded-lg h-full justify-center">
                        <button id="recordButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full transition-transform transform hover:scale-105 w-full text-lg flex items-center justify-center space-x-2">
                            <i class="fas fa-microphone"></i>
                            <span>Bắt đầu Ghi âm</span>
                        </button>
                        <div id="recordingStatus" class="mt-3 text-sm text-gray-500 h-5 flex items-center"></div>
                    </div>
                    <!-- Tải file -->
                    <div class="flex flex-col items-center p-4 border rounded-lg h-full justify-center">
                        <label for="fileInput" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full transition-transform transform hover:scale-105 w-full text-lg text-center cursor-pointer">
                            <i class="fas fa-upload"></i>
                            <span>Hoặc Chọn File Audio</span>
                        </label>
                        <input type="file" id="fileInput" class="hidden" accept="audio/*">
                        <p id="fileName" class="mt-3 text-sm text-gray-500 h-5 truncate w-full text-center"></p>
                    </div>
                </div>
                
                <!-- THÊM MỚI: Trình phát audio -->
                <audio id="audioPlayer" controls class="w-full mt-4 hidden"></audio>

                <!-- Văn bản chỉnh sửa -->
                <textarea id="transcribedText" class="w-full p-4 border border-gray-300 rounded-lg h-40 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 mt-4" placeholder="Văn bản từ audio sẽ xuất hiện ở đây. Bạn có thể chỉnh sửa trước khi phân tích..."></textarea>
            </section>
            
            <!-- Nút Phân tích -->
            <section class="text-center">
                <button id="analyzeButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-full text-xl transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:scale-100" disabled>
                    <i class="fas fa-magic-wand-sparkles mr-2"></i>Phân tích Văn bản
                </button>
            </section>
            
            <!-- Kết quả -->
            <section id="resultSection" class="hidden">
                <h2 class="text-2xl font-semibold my-4 border-b pb-2">2. Kết quả Phân tích</h2>
                <div id="status" class="text-center text-gray-600 h-8 mb-4 flex justify-center items-center"></div>
                <div id="resultContainer" class="bg-gray-50 p-4 rounded-lg"></div>
                 <div class="text-center mt-4">
                    <button id="exportButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg hidden">
                        <i class="fas fa-download"></i>
                        Xuất văn bản đã sửa
                    </button>
                </div>
            </section>
        </main>
    </div>

<script>
    // Lấy các element từ DOM
    const recordButton = document.getElementById('recordButton');
    const recordingStatus = document.getElementById('recordingStatus');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    // THÊM MỚI: Lấy element audio player
    const audioPlayer = document.getElementById('audioPlayer');
    const transcribedText = document.getElementById('transcribedText');
    const analyzeButton = document.getElementById('analyzeButton');
    const status = document.getElementById('status');
    const resultSection = document.getElementById('resultSection');
    const resultContainer = document.getElementById('resultContainer');
    const exportButton = document.getElementById('exportButton');

    let recorder;
    let audioChunks = [];
    let isRecording = false;

    // --- Xử lý Ghi âm ---
    recordButton.addEventListener('click', () => isRecording ? stopRecording() : startRecording());

    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(stream);
            recorder.ondataavailable = e => audioChunks.push(e.data);
            recorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                // THÊM MỚI: Hiển thị audio player cho bản ghi âm
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayer.src = audioUrl;
                audioPlayer.classList.remove('hidden');
                transcribe(new File([audioBlob], 'recording.webm'));
            };
            audioChunks = [];
            recorder.start();
            isRecording = true;
            recordButton.innerHTML = '<i class="fas fa-stop"></i><span>Dừng Ghi âm</span>';
            recordingStatus.innerHTML = '<span class="status-dot bg-red-500 mr-2"></span>Đang ghi âm...';
        } catch (error) { status.textContent = 'Lỗi: Không thể truy cập micro.'; }
    }

    function stopRecording() {
        if (recorder) {
            recorder.stop();
            isRecording = false;
            recordButton.innerHTML = '<i class="fas fa-microphone"></i><span>Bắt đầu Ghi âm</span>';
            recordingStatus.textContent = '';
        }
    }

    // --- Xử lý Tải file ---
    fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) {
            fileName.textContent = file.name;
            // THÊM MỚI: Hiển thị audio player cho file tải lên
            const audioUrl = URL.createObjectURL(file);
            audioPlayer.src = audioUrl;
            audioPlayer.classList.remove('hidden');
            transcribe(file);
        }
    });
    
    // --- Gửi audio đến backend để chuyển đổi sang text ---
    async function transcribe(file) {
        status.innerHTML = '<div class="loader mr-2"></div> Đang chuyển đổi audio...';
        resultSection.classList.add('hidden');
        analyzeButton.disabled = true;
        
        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/transcribe', { method: 'POST', body: formData });
            if (!response.ok) throw new Error((await response.json()).error);

            const data = await response.json();
            transcribedText.value = data.text;
            status.textContent = 'Chuyển đổi thành công! Sẵn sàng để phân tích.';
            analyzeButton.disabled = false;

        } catch (error) {
            status.textContent = `Lỗi: ${error.message}`;
        }
    }

    // --- Gửi văn bản đi phân tích ---
    analyzeButton.addEventListener('click', async () => {
        const textToAnalyze = transcribedText.value;
        if (!textToAnalyze.trim()) {
            alert("Vui lòng nhập văn bản để phân tích.");
            return;
        }

        status.innerHTML = '<div class="loader mr-2"></div> Đang phân tích...';
        resultSection.classList.remove('hidden');
        resultContainer.innerHTML = '';
        exportButton.classList.add('hidden');
        analyzeButton.disabled = true;
        
        const formData = new FormData();
        formData.append('text', textToAnalyze);
        
        try {
            const response = await fetch('/analyze', { method: 'POST', body: formData });
            if (!response.ok) throw new Error((await response.json()).error);
            
            const data = await response.json();
            displayResults(data.results);
            status.textContent = 'Phân tích hoàn tất!';
            exportButton.classList.remove('hidden');

        } catch(error) {
            status.textContent = `Lỗi: ${error.message}`;
        } finally {
            analyzeButton.disabled = false;
        }
    });

    // --- Hiển thị kết quả ---
    function displayResults(results) {
        if (!results || results.length === 0) {
            resultContainer.innerHTML = '<p class="text-gray-500">Không tìm thấy câu nào hợp lệ để phân tích.</p>';
            return;
        }

        let html = '<ul class="space-y-4">';
        results.forEach(item => {
            const borderColor = item.is_correct ? 'border-green-400' : 'border-orange-400';
            const bgColor = item.is_correct ? 'bg-green-50' : 'bg-orange-50';
            html += `<li class="sentence-container border-l-4 p-4 rounded-r-lg ${borderColor} ${bgColor}">`;
            
            if (item.is_correct) {
                html += `<p class="text-gray-800">${item.original}</p>`;
                html += `<div class="analysis-result mt-2 text-sm">
                            <span class="text-green-600 font-semibold"><i class="fas fa-check-circle mr-1"></i>Đúng</span>
                         </div>`;
            } else {
                 html += `<p class="original-text">${item.original}</p>`;
                 html += `<div class="analysis-result mt-2 text-sm">
                            <span class="corrected-text">→ ${item.corrected}</span>
                          </div>`;
            }
            html += '</li>';
        });
        html += '</ul>';
        resultContainer.innerHTML = html;
    }
    
    // --- Xuất file .txt ---
    exportButton.addEventListener('click', () => {
        const correctedParagraphs = [];
        const resultItems = resultContainer.querySelectorAll('li');
        
        resultItems.forEach(item => {
            const correctedSpan = item.querySelector('.corrected-text');
            if (correctedSpan) {
                correctedParagraphs.push(correctedSpan.textContent.replace('→ ', '').trim());
            } else {
                const originalP = item.querySelector('p');
                if (originalP) {
                    correctedParagraphs.push(originalP.textContent.trim());
                }
            }
        });

        const fullText = correctedParagraphs.join(' ');
        const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'corrected_text.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

</script>

</body>
</html>

