<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Analysis from Audio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-3xl bg-white rounded-xl shadow-lg p-8 space-y-6">
        
        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-900">Phân tích Ngữ pháp Tiếng Anh</h1>
            <p class="text-gray-600 mt-2">Tải lên file audio hoặc ghi âm trực tiếp để bắt đầu.</p>
        </header>

        <!-- Input Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
            <div class="flex flex-col items-center p-6 border-2 border-dashed border-gray-300 rounded-lg">
                <label for="audio-file" class="cursor-pointer bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                    Chọn file Audio
                </label>
                <input type="file" id="audio-file" accept="audio/*" class="hidden">
                <p id="file-name" class="mt-2 text-sm text-gray-500">Chưa chọn file nào</p>
            </div>
            
            <div class="flex flex-col items-center p-6 border-2 border-dashed border-gray-300 rounded-lg">
                <button id="record-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Bắt đầu Ghi âm</button>
                <p id="record-status" class="mt-2 text-sm text-gray-500">Nhấn để ghi âm</p>
            </div>
        </div>

        <!-- Transcription Section -->
        <div class="space-y-2">
            <div class="flex justify-between items-center">
                <label for="transcribed-text" class="font-semibold text-gray-700">Văn bản từ Audio (có thể chỉnh sửa):</label>
                <div id="transcribe-loader" class="loader hidden"></div>
            </div>
            <textarea id="transcribed-text" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" placeholder="Nội dung audio sẽ hiện ở đây..."></textarea>
        </div>

        <!-- Action Button -->
        <div class="text-center">
            <button id="analyze-btn" class="w-full md:w-1/2 bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors text-lg">
                Phân tích Ngữ pháp
            </button>
        </div>

        <!-- Result Section -->
        <div class="space-y-2">
            <div class="flex justify-between items-center">
                <label for="corrected-text" class="font-semibold text-gray-700">Kết quả Phân tích:</label>
                 <div id="correct-loader" class="loader hidden"></div>
            </div>
            <textarea id="corrected-text" rows="6" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50"></textarea>
            <button id="export-btn" class="mt-2 bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 transition-colors hidden">Xuất ra file .txt</button>
        </div>
    </div>

<script>
    const audioFileInput = document.getElementById('audio-file');
    const fileNameDisplay = document.getElementById('file-name');
    const transcribedTextarea = document.getElementById('transcribed-text');
    const analyzeBtn = document.getElementById('analyze-btn');
    const correctedTextarea = document.getElementById('corrected-text');
    const exportBtn = document.getElementById('export-btn');
    const transcribeLoader = document.getElementById('transcribe-loader');
    const correctLoader = document.getElementById('correct-loader');
    
    // Recording functionality
    const recordBtn = document.getElementById('record-btn');
    const recordStatus = document.getElementById('record-status');
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    // --- Event Listeners ---
    audioFileInput.addEventListener('change', () => {
        const file = audioFileInput.files[0];
        if (file) {
            fileNameDisplay.textContent = file.name;
            handleAudio(file);
        }
    });

    recordBtn.addEventListener('click', async () => {
        if (isRecording) {
            mediaRecorder.stop();
        } else {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            
            isRecording = true;
            audioChunks = [];
            recordBtn.textContent = 'Dừng Ghi âm';
            recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            recordBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            recordStatus.textContent = "Đang ghi âm...";

            mediaRecorder.addEventListener("dataavailable", event => {
                audioChunks.push(event.data);
            });

            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioFile = new File([audioBlob], "recording.wav", { type: 'audio/wav' });
                fileNameDisplay.textContent = "Bản ghi âm";
                handleAudio(audioFile);
                
                isRecording = false;
                recordBtn.textContent = 'Bắt đầu Ghi âm';
                recordBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                recordStatus.textContent = "Nhấn để ghi âm";
                stream.getTracks().forEach(track => track.stop());
            });
        }
    });

    analyzeBtn.addEventListener('click', handleGrammarCorrection);

    exportBtn.addEventListener('click', () => {
        const textToExport = correctedTextarea.value;
        if (!textToExport) return;

        const blob = new Blob([textToExport], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'corrected_text.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    // --- API Call Functions ---

    async function handleAudio(file) {
        transcribeLoader.classList.remove('hidden');
        transcribedTextarea.value = '';
        correctedTextarea.value = '';
        exportBtn.classList.add('hidden');

        const formData = new FormData();
        formData.append('audio_file', file);

        try {
            const response = await fetch('/transcribe', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (response.ok) {
                transcribedTextarea.value = data.transcription;
            } else {
                alert('Lỗi: ' + data.error);
            }
        } catch (error) {
            alert('Đã có lỗi xảy ra khi kết nối tới server.');
            console.error(error);
        } finally {
            transcribeLoader.classList.add('hidden');
        }
    }

    async function handleGrammarCorrection() {
        const text = transcribedTextarea.value;
        if (!text) {
            alert('Vui lòng nhập văn bản hoặc transcribe từ audio trước.');
            return;
        }

        correctLoader.classList.remove('hidden');
        correctedTextarea.value = '';
        exportBtn.classList.add('hidden');

        try {
            const response = await fetch('/correct_grammar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });
            const data = await response.json();

            if (response.ok) {
                correctedTextarea.value = data.corrected_text;
                if (data.corrected_text) {
                    exportBtn.classList.remove('hidden');
                }
            } else {
                alert('Lỗi: ' + data.error);
            }
        } catch (error) {
            alert('Đã có lỗi xảy ra khi kết nối tới server.');
            console.error(error);
        } finally {
            correctLoader.classList.add('hidden');
        }
    }
</script>

</body>
</html>

